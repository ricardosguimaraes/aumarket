"use strict";var WPMailSMTP=window.WPMailSMTP||{};WPMailSMTP.Admin=WPMailSMTP.Admin||{},WPMailSMTP.Admin.Alerts=WPMailSMTP.Admin.Alerts||{},WPMailSMTP.Admin.Alerts.PushNotifications=WPMailSMTP.Admin.Alerts.PushNotifications||function(e,r,a){var n={localSubscriptionKey:"WPMailSMTPPushNotificationsSubscription",publicKey:a.publicKey,init:function(){r(n.ready)},ready:async function(){r("#wp-mail-smtp-setting-alert-push_notifications-enabled").is(":checked")&&(await n.refreshSubscriptions(),n.highlightCurrentSubscription(),n.refreshSubscribeButton()),n.bindActions()},bindActions:function(){r(".wp-mail-smtp-tab-alerts").on("click","#wp-mail-smtp-setting-alert-push_notifications-enabled",n.toggleSettings).on("click","#wp-mail-smtp-setting-alert-push_notifications-subscribe",n.addSubscription).on("click",".js-wp-mail-smtp-setting-alert-push_notifications-remove-subscription",n.removeSubscription)},checkRequirements:function(){if(!("serviceWorker"in navigator&&"PushManager"in e&&"Notification"in e))throw new Error(`${a.notices.unsupported}.`);if("denied"===Notification.permission)throw new Error(`${a.notices.permission_denied}.`)},getLocalSubscription(){var i=localStorage.getItem(n.localSubscriptionKey);try{return i?JSON.parse(i):null}catch(i){return null}},setLocalSubscription:function(i){localStorage.setItem(n.localSubscriptionKey,JSON.stringify(i))},getPushManager:async function(){try{var i=await navigator.serviceWorker.register(a.serviceWorkerUrl);return await navigator.serviceWorker.ready,i.pushManager}catch(i){throw new Error(`${a.notices.service_worker}: ${i.message}.`)}},getSubscription:async function(i){try{return await i.getSubscription()}catch(i){throw new Error(`${a.notices.subscription}: ${i.message}.`)}},urlBase64ToUint8Array:function(i){i=(i+"=".repeat((4-i.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/");const t=e.atob(i),s=new Uint8Array(t.length);for(let i=0;i<t.length;++i)s[i]=t.charCodeAt(i);return s},subscribe:async function(){const i=await n.getPushManager();try{var t={userVisibleOnly:!0,applicationServerKey:n.urlBase64ToUint8Array(n.publicKey)};return await i.subscribe(t)}catch(i){throw new Error(`${a.notices.subscribe}: ${i.message}`)}},unsubscribe:async function(){var i=await n.getPushManager();const t=await n.getSubscription(i);if(null!==t){try{await t.unsubscribe()}catch(i){throw new Error(`${a.notices.unsubscribe}: ${i.message}`)}null!==n.getLocalSubscription()&&localStorage.removeItem(n.localSubscriptionKey)}},toggleSettings:async function(i){i.preventDefault();var t,s=r(this),i=r(this).closest(".wp-mail-smtp-setting-row-alert").find(".wp-mail-smtp-setting-row-alert-options");s.prop("disabled",!0),r(this).is(":checked")?(t=await n.enablePushAlertsSite()).success?(r(this).prop("checked",!0),n.publicKey=t.data.public_key,r("#wp-mail-smtp-push-notifications-public-key").val(t.data.public_key),n.hideNotices(),i.show(),await n.refreshSubscriptions(),n.highlightCurrentSubscription(),n.refreshSubscribeButton()):n.displayNotice("site",`${a.notices.request}: ${t.data.message}`):(t=await n.disablePushAlertsSite()).success?(r(this).prop("checked",!1),i.hide(),n.hideNotices()):n.displayNotice("site",`${a.notices.request}: ${t.data.message}`),s.prop("disabled",!1)},addSubscription:async function(i){i.preventDefault();i=r(this);n.hideNotices();try{if("granted"!==await Notification.requestPermission())return;i.addClass("loading");var t=await n.subscribe(),s=await n.createSubscription(t);s.success?n.setLocalSubscription(s.data):n.displayNotice("subscription",`${a.notices.request}: ${s.data.message}`),await n.refreshSubscriptions(),n.highlightCurrentSubscription(),n.refreshSubscribeButton()}catch(i){n.displayNotice("subscription",i.message)}finally{i.removeClass("loading"),n.refreshSubscribeButton()}},removeSubscription:async function(i){i.preventDefault();var t=r(this),s=r(this).closest(".wp-mail-smtp-setting-row").attr("data-subscription-id"),i=n.getLocalSubscription();if(n.hideNotices(),t.addClass("loading"),i&&i.id===s)try{await n.unsubscribe()}catch(i){return n.displayNotice("subscription",i.message),void t.removeClass("loading")}s=await n.deleteSubscription(s);s.success?(await n.refreshSubscriptions(),n.refreshSubscribeButton()):n.displayNotice("subscription",`${a.notices.request}: ${s.data.message}`),t.removeClass("loading")},refreshSubscriptions:async function(){var i=r("#wp-mail-smtp-setting-row-alert-push_notifications-subscriptions"),t=await n.getSubscriptions();t.success?i.html(t.data):n.displayNotice("subscription",`${a.notices.request}: ${t.data.message}`)},refreshSubscribeButton:async function(){try{n.checkRequirements()}catch(i){return void n.displayNotice("subscription",i.message)}var i=r("#wp-mail-smtp-setting-alert-push_notifications-subscribe"),t=n.getLocalSubscription();t&&0<r(`[data-subscription-id="${t.id}"]`).length?i.prop("disabled",!0):i.prop("disabled",!1)},highlightCurrentSubscription:function(){var i=n.getLocalSubscription();i&&r(`[data-subscription-id="${i.id}"]`).addClass("current-subscription")},displayNotice:function(i,t){i=r(`#wp-mail-smtp-push-notifications-${i}-notice`);r("p",i).html(t),i.show()},hideNotices:function(){var i=r(".wp-mail-smtp-push-notifications-notice");r("p",i).html(""),i.hide()},enablePushAlertsSite:async function(){return await r.post(a.apiUrl,{task:"enable_site"})},disablePushAlertsSite:async function(){return await r.post(a.apiUrl,{task:"disable_site"})},getSubscriptions:async function(){return await r.post(a.apiUrl,{task:"get_subscriptions"})},createSubscription:async function(i){return await r.post(a.apiUrl,{task:"create_subscription",user_agent:navigator.userAgent,details:JSON.stringify(i.toJSON())})},deleteSubscription:async function(i){return await r.post(a.apiUrl,{task:"delete_subscription",subscription_id:i})}};return n}((document,window),jQuery,WPMailSMTPPushNotificationsSettings),WPMailSMTP.Admin.Alerts.PushNotifications.init();